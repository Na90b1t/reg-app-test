# AuthService

Сервис для управления авторизацией и регистрацией пользователей через REST API.

## Текущая реализация

Работает через HTTP запросы к бэкенду на `http://localhost:3000/api/auth`. Использует JWT токены для авторизации. Токен сохраняется в `localStorage` и автоматически добавляется в заголовки запросов.

## Пользовательские типы

- `user` — стандартный пользователь, использует email как логин
- `mop` — агент, использует код из 5 цифр вместо email

## Основные методы

- `register(payload: { name, password, type, email?, identifier? })` — регистрация пользователя заданного типа
- `login(payload: { password, type, email?, identifier? })` — авторизация пользователя заданного типа
- `logout(): void` — выход из системы
- `getCurrentUser(): User | null` — получить текущего авторизованного пользователя
- `isAuthenticated(): boolean` — проверить, авторизован ли пользователь
- `getToken(): string | null` — получить токен авторизации
- `currentUser$: Observable<User | null>` — Observable для отслеживания текущего пользователя

## Как это работает

1. При регистрации/входе отправляется HTTP запрос на бэкенд. Для `user` передаётся email, для `mop` — код из 5 цифр.
2. Бэкенд возвращает JWT токен и данные пользователя
3. Токен сохраняется в `localStorage`
4. При каждом запросе токен автоматически добавляется в заголовок `Authorization: Bearer TOKEN`
5. При перезагрузке страницы токен читается из `localStorage` и отправляется запрос `/api/auth/me` для восстановления данных пользователя

## Агент MOP (mop)

1. Вход осуществляется только через Auth0 (OIDC + PKCE).
2. После успешной аутентификации Auth0 возвращает:
    - id_token (с данными пользователя),
    - access_token (для доступа к API).
3. Приложение отправляет access_token на бэкенд в запросе к /api/auth/exchange (или аналогичному эндпоинту).
4. Бэкенд:
    - Валидирует токен (проверяет подпись, issuer, audience),
    - Извлекает данные пользователя (email, роль и т.д.),
    - Создаёт или обновляет запись агента в системе,
    - Возвращает внутренний JWT-токен (или использует оригинальный — в зависимости от архитектуры).

5. Этот токен сохраняется в localStorage, и дальнейшая логика совпадает с обычным пользователем:

- Автоматическая подстановка в Authorization-заголовок,
- Восстановление сессии через /api/auth/me.
⚠️ Важно: для mop не используется email/пароль в UI, а код агента не требуется, если все данные приходят из Auth0.

## Хранение данных

- Токен: `localStorage.getItem('auth_token')`
- Текущий пользователь: `localStorage.getItem('auth_current_user')`

## Обработка ошибок

Сервис обрабатывает ошибки от API и передает их в компоненты через Observable. Компоненты могут отображать ошибки пользователю.

## Зависимости

- `HttpClient` — для HTTP запросов
- `RxJS` — для работы с Observable
- Бэкенд API на `http://localhost:3000/api/auth`
